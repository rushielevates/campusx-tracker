<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - CampusX ML Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar Styles */
        .sidebar { width: 300px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar-header { padding: 30px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-header h2 { font-size: 24px; margin-bottom: 5px; }
        .sidebar-header p { opacity: 0.9; font-size: 14px; }
        
        .user-info { padding: 20px; display: flex; align-items: center; border-bottom: 1px solid #e0e0e0; }
        .user-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px; }
        .user-details { display: flex; flex-direction: column; }
        .user-details span:first-child { font-weight: 600; color: #333; }
        .user-details span:last-child { font-size: 12px; color: #666; }
        
        .playlists-section { flex: 1; padding: 20px; overflow-y: auto; }
        .playlists-section h3 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .playlist-item { padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; }
        .playlist-item:hover { background: #e9ecef; transform: translateX(5px); }
        .playlist-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .playlist-title { font-weight: 600; margin-bottom: 5px; }
        .playlist-stats { font-size: 12px; color: #666; }
        .playlist-item.active .playlist-stats { color: rgba(255,255,255,0.9); }
        
        .import-btn { margin: 20px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.3s; }
        .import-btn:hover { transform: translateY(-2px); }
        .import-btn span { margin-right: 5px; font-size: 18px; }
        
        .logout-btn { margin: 0 20px 20px; padding: 10px; background: none; border: 2px solid #dc3545; color: #dc3545; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: #dc3545; color: white; }
        
        /* Main Content Styles */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5; }
        
        /* Player Section */
        .player-section { 
            background: black; 
            border-radius: 15px 15px 0 0; 
            overflow: hidden; 
            position: relative; 
            margin-bottom: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        #youtube-player { 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: #000;
            display: block;
        }

      

        /* Fullscreen styles */
        .player-section:-webkit-full-screen #youtube-player {
            height: 100vh;
            width: 100vw;
        }

        .player-section:-moz-full-screen #youtube-player {
            height: 100vh;
            width: 100vw;
        }

        .player-section:fullscreen #youtube-player {
            height: 100vh;
            width: 100vw;
        }
        
        /* Playlist View */
        .playlist-view { background: white; border-radius: 0 0 15px 15px; padding: 20px; }
        
        .playlist-header { margin-bottom: 20px; }
        .playlist-header h1 { font-size: 28px; margin-bottom: 10px; color: #333; }
        
        .playlist-meta { display: flex; gap: 30px; margin: 20px 0; }
        .meta-item { text-align: center; }
        .meta-label { font-size: 12px; color: #666; }
        .meta-value { font-size: 24px; font-weight: bold; color: #667eea; }
        
        .speed-control { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .speed-control label { display: block; margin-bottom: 10px; font-weight: 600; color: #333; }
        .speed-input { display: flex; align-items: center; gap: 15px; }
        .speed-input input { flex: 1; height: 40px; }
        .speed-value { font-weight: 600; color: #667eea; min-width: 60px; }
        .remaining-time { margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2; font-weight: 500; }
        
        .videos-list { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .video-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s; }
        .video-item:hover { background: #f8f9fa; }
        .video-item.completed { opacity: 0.7; }
        .video-item.active { background: #e3f2fd; border-left: 4px solid #667eea; }
        .video-checkbox { margin-right: 15px; width: 20px; height: 20px; cursor: pointer; }
        .video-thumbnail { width: 120px; height: 68px; background: #ddd; border-radius: 5px; margin-right: 15px; overflow: hidden; }
        .video-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .video-info { flex: 1; }
        .video-title { font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        .video-duration { font-size: 12px; color: #666; }
        .video-number { margin-right: 20px; color: #999; font-size: 14px; }
        
        .loading { text-align: center; padding: 50px; color: #666; }
        .error-message { text-align: center; padding: 20px; color: #dc3545; background: #fee; border-radius: 5px; margin: 20px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>CampusX ML</h2>
                <p>Your Learning Progress</p>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">CX</div>
                <div class="user-details">
                    <span id="username">Loading...</span>
                    <span id="user-email"></span>
                </div>
            </div>

            <div class="playlists-section">
                <h3>Your Playlists</h3>
                <div id="playlists-list">
                    <div class="loading">Loading playlists...</div>
                </div>
            </div>

            <button class="import-btn" onclick="importPlaylist()">
                <span>+</span> Import CampusX ML
            </button>

            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- YouTube Player Section -->
            <div class="player-section" id="player-section" style="display: none;">
                <div id="youtube-player"></div>
              
            </div>

            <!-- Playlist View -->
            <div id="playlist-view" class="playlist-view">
                <div class="loading">Select a playlist to start tracking</div>
            </div>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // Global variables
        let currentPlaylist = null;
        let player = null;
        let currentVideoId = null;
        
        // Load data when page loads
        window.onload = async function() {
            console.log('Dashboard loaded');
            await loadUserInfo();
            await loadPlaylists();
        };

        // Load user info
        async function loadUserInfo() {
            try {
                document.getElementById('username').textContent = 'CampusX Learner';
                document.getElementById('user-email').textContent = 'learner@campusx.com';
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Load playlists
        async function loadPlaylists() {
            try {
                console.log('Loading playlists...');
                const response = await fetch('/api/playlists/user-playlists');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Failed to load playlists');
                }
                
                const playlists = await response.json();
                console.log('Playlists loaded:', playlists);
                
                const playlistsList = document.getElementById('playlists-list');
                
                if (!playlists || playlists.length === 0) {
                    playlistsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No playlists yet. Click import to get started!</div>';
                    return;
                }
                
                playlistsList.innerHTML = '';
                playlists.forEach(playlist => {
                    const playlistEl = createPlaylistElement(playlist);
                    playlistsList.appendChild(playlistEl);
                });
                
                if (playlists.length > 0) {
                    loadPlaylist(playlists[0]._id);
                }
            } catch (error) {
                console.error('Error loading playlists:', error);
                document.getElementById('playlists-list').innerHTML = '<div class="error-message">Error loading playlists. Please try again.</div>';
            }
        }

        // Create playlist element
        function createPlaylistElement(playlist) {
            const div = document.createElement('div');
            div.className = 'playlist-item';
            div.setAttribute('data-id', playlist._id);
            div.onclick = () => loadPlaylist(playlist._id);
            
            const videoCount = playlist.videos ? playlist.videos.length : 0;
            const completedCount = playlist.videos ? playlist.videos.filter(v => v.completed).length : 0;
            
            div.innerHTML = `
                <div class="playlist-title">${playlist.title || 'Untitled Playlist'}</div>
                <div class="playlist-stats">${completedCount}/${videoCount} videos</div>
            `;
            
            return div;
        }

        // Load specific playlist
        async function loadPlaylist(playlistId) {
            try {
                console.log('Loading playlist:', playlistId);
                
                document.querySelectorAll('.playlist-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-id') === playlistId) {
                        item.classList.add('active');
                    }
                });
                
                const response = await fetch(`/api/playlists/${playlistId}`);
                if (!response.ok) {
                    throw new Error('Failed to load playlist');
                }
                
                const playlist = await response.json();
                console.log('Playlist loaded:', playlist);
                
                currentPlaylist = playlist;
                displayPlaylist(playlist);
                
                if (playlist.lastWatched && playlist.lastWatched.videoId) {
                    playVideo(playlist.lastWatched.videoId, playlist.lastWatched.title);
                }
            } catch (error) {
                console.error('Error loading playlist:', error);
                document.getElementById('playlist-view').innerHTML = '<div class="error-message">Error loading playlist</div>';
            }
        }

        // Display playlist
        function displayPlaylist(playlist) {
            const view = document.getElementById('playlist-view');
            
            if (!playlist || !playlist.videos) {
                view.innerHTML = '<div class="error-message">Invalid playlist data</div>';
                return;
            }
            
            const completed = playlist.videos.filter(v => v.completed).length;
            const total = playlist.videos.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            const remainingTime = 'Calculating...';
            
            view.innerHTML = `
                <div class="playlist-header">
                    <h1>${playlist.title || 'CampusX ML Playlist'}</h1>
                    <div class="playlist-meta">
                        <div class="meta-item">
                            <div class="meta-label">Videos</div>
                            <div class="meta-value">${total}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Completed</div>
                            <div class="meta-value">${completed}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Progress</div>
                            <div class="meta-value">${percentage}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="speed-control">
                    <label>Playback Speed</label>
                    <div class="speed-input">
                        <input type="range" min="0.5" max="2" step="0.25" value="${playlist.playlistSpeed || 1}" onchange="updateSpeed(this.value)">
                        <span class="speed-value" id="speed-display">${playlist.playlistSpeed || 1}x</span>
                    </div>
                    <div class="remaining-time" id="remaining-time">
                        ⏱️ Remaining time: ${remainingTime}
                    </div>
                </div>
                
                <div class="videos-list">
                    ${playlist.videos.map((video, index) => `
                        <div class="video-item ${video.completed ? 'completed' : ''} ${video.videoId === currentVideoId ? 'active' : ''}" 
                             onclick="playVideo('${video.videoId}', '${video.title.replace(/'/g, "\\'")}')">
                            <input type="checkbox" class="video-checkbox" ${video.completed ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleVideoComplete('${video._id}')">
                            <span class="video-number">${index + 1}</span>
                            <div class="video-thumbnail">
                                <img src="${video.thumbnail || 'https://via.placeholder.com/120x68'}" alt="${video.title}">
                            </div>
                            <div class="video-info">
                                <div class="video-title">${video.title || `Video ${index + 1}`}</div>
                                <div class="video-duration">${formatDuration(video.duration)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Format duration from seconds to MM:SS or HH:MM:SS
        function formatDuration(seconds) {
            if (!seconds) return '00:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // YouTube Player Functions
        function onYouTubeIframeAPIReady() {
            console.log('✅ YouTube API loaded successfully');
        }

        function onPlayerReady(event) {
            console.log('✅ Player ready');
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                console.log('Video ended');
                if (currentPlaylist && currentPlaylist.videos) {
                    const currentIndex = currentPlaylist.videos.findIndex(v => v.videoId === currentVideoId);
                    if (currentIndex >= 0 && currentIndex < currentPlaylist.videos.length - 1) {
                        const nextVideo = currentPlaylist.videos[currentIndex + 1];
                        setTimeout(() => {
                            playVideo(nextVideo.videoId, nextVideo.title);
                        }, 3000);
                    }
                }
            }
        }

        function onPlayerError(event) {
            console.error('❌ Player error:', event.data);
            let errorMessage = 'Unknown error';
            
            switch(event.data) {
                case 2:
                    errorMessage = 'Invalid video ID';
                    break;
                case 5:
                    errorMessage = 'HTML5 player error';
                    break;
                case 100:
                    errorMessage = 'Video not found or removed';
                    break;
                case 101:
                case 150:
                    errorMessage = 'Video cannot be embedded';
                    break;
            }
            
            alert('Error playing video: ' + errorMessage);
        }

        function playVideo(videoId, videoTitle) {
            console.log('Playing video:', videoId);
            
            if (!videoId) {
                console.error('No video ID provided');
                return;
            }
            
            const playerSection = document.getElementById('player-section');
            playerSection.style.display = 'block';
            
            document.getElementById('now-playing').textContent = videoTitle || 'Now playing';
            
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const videoItems = document.querySelectorAll('.video-item');
            for (let item of videoItems) {
                const titleElement = item.querySelector('.video-title');
                if (titleElement && videoTitle && titleElement.textContent.includes(videoTitle.substring(0, 20))) {
                    item.classList.add('active');
                    break;
                }
            }
            
            if (!player) {
                console.log('Creating new YouTube player...');
                
                try {
                    player = new YT.Player('youtube-player', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: {
                            autoplay: 1,
                            controls: 2,
                            rel: 0,
                            modestbranding: 1,
                            iv_load_policy: 3,
                            cc_load_policy: 0,
                            fs: 1,
                            playsinline: 1,
                            disablekb: 0,
                            enablejsapi: 1,
                            origin: window.location.origin,
                            color: 'red',
                            autohide: 0,
                            theme: 'dark'
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                    console.log('Player creation initiated');
                } catch (e) {
                    console.error('Error creating player:', e);
                }
            } else {
                console.log('Loading video in existing player');
                try {
                    player.loadVideoById(videoId);
                } catch (e) {
                    console.error('Error loading video:', e);
                }
            }
            
            currentVideoId = videoId;
        }

        function toggleFullscreen() {
            const playerSection = document.getElementById('player-section');
            if (!document.fullscreenElement) {
                playerSection.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Import playlist
        async function importPlaylist() {
            try {
                console.log('Importing playlist...');
                const button = document.querySelector('.import-btn');
                button.disabled = true;
                button.innerHTML = '⏳ Importing...';
                
                const response = await fetch('/api/playlists/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Import response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`✅ Playlist imported successfully! ${data.playlist.videoCount} videos found.`);
                    await loadPlaylists();
                } else {
                    const error = await response.json();
                    alert('❌ Failed to import: ' + (error.error || error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error importing:', error);
                alert('❌ Error importing playlist. Please try again.');
            } finally {
                const button = document.querySelector('.import-btn');
                button.disabled = false;
                button.innerHTML = '<span>+</span> Import CampusX ML';
            }
        }

        // Toggle video completion
        async function toggleVideoComplete(videoId) {
            if (!currentPlaylist) return;
            
            try {
                const response = await fetch(`/api/playlists/${currentPlaylist._id}/video/${videoId}/toggle`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadPlaylist(currentPlaylist._id);
                    await loadPlaylists();
                }
            } catch (error) {
                console.error('Error toggling video:', error);
            }
        }

        // Update playback speed
        async function updateSpeed(speed) {
            document.getElementById('speed-display').textContent = speed + 'x';
            
            if (!currentPlaylist) return;
            
            try {
                await fetch(`/api/playlists/${currentPlaylist._id}/speed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ speed: parseFloat(speed) })
                });
            } catch (error) {
                console.error('Error updating speed:', error);
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout');
                window.location.href = '/';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Check if YouTube API loaded
        setTimeout(function() {
            if (typeof YT === 'undefined' || !YT.Player) {
                console.error('❌ YouTube API failed to load');
                alert('YouTube player failed to load. Please refresh the page.');
            } else {
                console.log('✅ YouTube API is available');
            }
        }, 5000);
    </script>
</body>
</html>
